// .env ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
require('dotenv').config();

const express = require('express');
const app = express();
app.get('/', (req, res) => res.send('Bot is alive!'));
app.listen(process.env.PORT || 3000, () => {
    console.log(`ğŸŒ Webã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­ on ${process.env.PORT || 3000}`);
});

// ãã®ä»–ã® require ã«ç¶šã‘ã¦
const cron = require('node-cron');
const channelId = process.env.CHANNEL_ID;

// discord.js ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆv14ä»¥é™ã®æ§‹æ–‡ï¼‰
const { Client, GatewayIntentBits } = require('discord.js');

// Botã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ã«å¿…è¦ãªã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’è¨­å®šï¼‰
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent
    ]
});

// ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã¨ãï¼‰
const replies = [
    'ç§ã®å‹²ç« ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¦‹ã¦ã¿ã‚‹ã‹ï¼Ÿ',
    'æŒ‡æ®å®˜ã‹ï¼Ÿâ€¦â€¦æœ€è¿‘ã€è‡ªåˆ†ãŒå¯¾æ½œæˆ¦ã‚‚å‡ºæ¥ã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã„å§‹ã‚ãŸãŒâ€¦',
    'é‹ã‚‚å®ŸåŠ›ã®ã†ã¡ï¼Ÿã§ãã‚Œã°å°‘ã—å§‰ã«ã‚‚åˆ†ã‘ã¦ã‚ã’ãŸã„ã‚‚ã®ã ãª',
    'ç”Ÿãã¦ã„ã‚‹é™ã‚Šã€æ€ã„é€šã‚Šã«ãªã‚‰ãªã„ã“ã¨ã¯ã„ãã‚‰ã§ã‚‚ã‚ã‚‹ã€‚æ­»ã«ã‚†ããªã‚‰æ‚”ã„ã‚’æ®‹ã•ãªã„ã‚ˆã†ã«ã—ãŸã„ã‚‚ã®ã ',
    'ãªã‚“ã ã€å‡ºæ’ƒã‹ï¼Ÿ',
    'æˆ¦ã„ã®æ¬¡ã«ã¾ãŸæˆ¦ã„ã€ã‹â€¦â€¦',
    'æŒ‡æ®å®˜ã€æ•™ãˆã¦ãã‚Œã€‚ç§ã¯ã‚ã¨ä½•éš»æ²ˆã‚ã‚Œã°ã„ã„ï¼Ÿ',
    'ç´ ç›´ã§èª å®Ÿã«ç”Ÿãã¦ã„ãã®ãŒé¡˜ã„ã ã€‚ã ã‹ã‚‰æ„è¦‹ãŒã‚ã£ãŸã‚‰ã“ã£ã¡ã‹ã‚‰é æ…®ãªãè¨€ã‚ã›ã¦ã‚‚ã‚‰ã†ã€‚ãã£ã¡ã‚‚è€ƒãˆãŒã‚ã£ãŸã‚‰ãªã‚“ã§ã‚‚é æ…®ãªãè¨€ã£ã¦ãã‚Œ',
    'å¤©ã®å…‰ã¯å…¨ã¦æ˜Ÿã€æµ·ã®å…‰ã¯å…¨ã¦æ•µâ€¦â€¦æŒ‡æ®å®˜ã€äº‰ã„ã®ãªã„æ—¥ã¯æœãŸã—ã¦æ¥ã‚‹ã®ã ã‚ã†ã‹',
    'æˆ¦äº‰ãŒçµ‚ã‚ã£ãŸã‚‰ä½•ãŒã—ãŸã„ï¼Ÿâ€•â€•ç§ï¼Ÿå¤šåˆ†ã‚ãªãŸã«ã¤ã„ã¦ã„ãã ã‚ã†ãªã€‚æˆ¦å ´ä»¥å¤–ãªã‚‰ã‚ãªãŸã®ãã°ãŒä¸€ç•ªå®‰å¿ƒã™ã‚‹ã€‚ç§ã‚’é€£ã‚Œã¦ã„ã£ã¦â€¦â€¦ã‚‚ã‚‰ãˆã‚‹ã‹ï¼Ÿ',
    'å†™çœŸã‚’æ’®ã‚‹ã®ã‹ï¼Ÿåˆ†ã‹ã£ãŸã€ãƒãƒ¼ã‚ºã¯ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿ',
    'ãƒ«ãƒ¼ãƒ«é•åã ãã€‚æŒ‡æ®å®˜',
    'åŠ©ã‘ãŒå¿…è¦ã‹ï¼Ÿ',
    'ã‚ã£â€¦ï¼â€¦ã‚ã–ã¨ã˜ã‚ƒãªã„ã‹ï¼Ÿ',
    'ã‚ãªãŸã®å´ã«ã„ã‚Œã°ã€ãŸã¨ãˆã©ã‚“ãªã«è‹¦ã—ã„æˆ¦ã„ã§ã‚‚ã€ã©ã‚“ãªã«æ‚²ã—ã„åˆ¥ã‚ŒãŒæ¥ã¦ã‚‚ã€ãã£ã¨å¸Œæœ›ã‚’ã‚‚ã£ã¦ä¹—ã‚Šè¶Šãˆã‚‹ã“ã¨ãŒã§ãã‚‹',
    'ä»Šæ—¥ã®å¤•é¤‰ã¯ç§ã«ä»»ã›ã¦ãã‚Œãªã„ã‹ï¼Ÿãƒ´ã‚§ã‚¹ã‚¿ãƒ«ã‹ã‚‰ã‚‚ã†æ•™ãˆã‚‹ã“ã¨ã¯ãªã„ã£ã¦è¨€ã‚ã‚ŒãŸã‹ã‚‰ãªã€‚â€¦â€¦ãµã£ã€æˆ¦é—˜ã—ã‹èƒ½ãŒãªã„ç§ã˜ã‚ƒãªã„ã',
    'ã„ã¤ã‹æˆ¦äº‰ãŒçµ‚ã‚ã£ã¦ã€äººã€…ãŒå¿ƒã‹ã‚‰ç¬‘ã„åˆãˆã‚‹æ—¥ãŒãã£ã¨æ¥ã‚‹ã¨ä¿¡ã˜ã¦ã„ã‚‹ã€‚æŒ‡æ®å®˜ã€ã‚ãªãŸãŒã„ã¦ãã‚ŒãŸãŠã‹ã’ã ',
    'åŠ›ã®æœã¦ã«ä½•ãŒã‚ã‚‹ã®ã‹â€¦â€¦è¦‹ã•ã›ã¦ã‚‚ã‚‰ãŠã†'
];

// ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹æ™‚ç”¨ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
const replies_training = [
    'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ™‚é–“ã ã€æŒ‡æ®å®˜',
    'å®šåˆ»ã ã€æŒ‡æ®å®˜ã€‚ä»Šæ—¥ã‚‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å§‹ã‚ã‚ˆã†',
    'çµ‚ã‚ã‚Šã ï¼',
    'æŒ‡æ®å®˜ã‚ˆã€‚ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã¾ã çµ‚ã‚ã£ã¦ãªã„ãã€‚æ—©ãå‡ºç™ºã™ã‚‹ã®ã ',
    'æŒ‡æ®å®˜ã€æ¬¡ã®ç›®çš„åœ°ã¸å‘ã‹ã†å‰ã«ã¾ãšã¯ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®é€²æ—ç¢ºèªã‚’',
    'ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã¾ã çµ‚ã‚ã£ã¦ã„ãªã„ãã€‚é€²æ—ã‚’ç¢ºèªã—ã»ã†ãŒã„ã„'
];


// BotãŒæº–å‚™å®Œäº†ã—ãŸã‚ã¨ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
client.once('ready', () => {
    console.log(`ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼Botåï¼š${client.user.tag}`);

    // æ—¥æœ¬æ™‚é–“ã§æ¯æ—¥19:30ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆUTCæ›ç®—ï¼š10:30ï¼‰
    cron.schedule('0 30 19 * * *', async () => {
        const channel = await client.channels.fetch(channelId);
        if (channel && channel.isTextBased()) {
            const reply = replies_training[Math.floor(Math.random() * replies_training.length)];
            channel.send('@everyone\n' + reply);
        }
        else
        {
            console.log("ãƒãƒ£ãƒ³ãƒãƒ«ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
        }
    }, {
        timezone: "Asia/Tokyo" // æ—¥æœ¬æ™‚é–“ã‚’æŒ‡å®š
    });
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
client.on('messageCreate', message => {
    // Botè‡ªèº«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯åå¿œã—ãªã„
    if (message.author.bot) return;

    // ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰è¿”äº‹ã™ã‚‹ä¾‹
    if (message.content === 'ã“ã‚“ã«ã¡ã¯') {
        message.channel.send(`ã“ã‚“ã«ã¡ã¯ã€${message.author.username}`);
    }
});

// ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚‰åå¿œ
client.on('messageCreate', message => {
    if (message.author.bot) return;

    const isMentioned = message.mentions.has(client.user);

    if (isMentioned) {
        const reply = replies[Math.floor(Math.random() * replies.length)];
        message.channel.send(`${message.author}\n ${reply}`);
    }
});

// ãƒˆãƒ¼ã‚¯ãƒ³ã§Botã«ãƒ­ã‚°ã‚¤ãƒ³
client.login(process.env.DISCORD_TOKEN);